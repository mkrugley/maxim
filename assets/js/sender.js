// Ваш публичный GPG-ключ (замените на свой)
const PUBLIC_KEY = `-----BEGIN PGP PUBLIC KEY BLOCK-----

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
gHLutrI8e+KMPS1Q1Zc=
=y34T
-----END PGP PUBLIC KEY BLOCK-----`;

// Функция для показа статуса
function showStatus(message, type) {
    const statusDiv = document.getElementById('form-status');
    statusDiv.style.display = 'block';
    statusDiv.textContent = message;

    if (type === 'success') {
        statusDiv.style.backgroundColor = '#0f4c3a';
        statusDiv.style.color = '#4ade80';
        statusDiv.style.border = '1px solid #4ade80';
    } else {
        statusDiv.style.backgroundColor = '#4c1d1d';
        statusDiv.style.color = '#f87171';
        statusDiv.style.border = '1px solid #f87171';
    }
}

// Обработка формы
document.getElementById('encrypted-contact-form').addEventListener('submit', async function (e) {
    e.preventDefault();

    const formBtn = document.querySelector('[data-form-btn]');
    const originalText = formBtn.innerHTML;

    // Показываем процесс шифрования
    formBtn.innerHTML = '<ion-icon name="hourglass"></ion-icon><span>Шифрую сообщение...</span>';
    formBtn.disabled = true;

    try {
        // Получаем данные формы
        const formData = new FormData(this);
        const name = formData.get('fullname');
        const email = formData.get('email');
        const message = formData.get('message');

        // Создаём полное сообщение со всеми данными
        const fullMessage = `От: ${name}
Email: ${email}
Дата: ${new Date().toLocaleString('ru-RU')}


Сообщение:
${message}`;

        // Шифруем сообщение
        const encrypted = await openpgp.encrypt({
            message: await openpgp.createMessage({ text: fullMessage }),
            encryptionKeys: await openpgp.readKey({ armoredKey: PUBLIC_KEY }),
            format: 'armored'
        });

        // Отправляем ТОЛЬКО зашифрованное содержимое
        const response = await fetch('https://api.web3forms.com/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                access_key: 'd3b2562a-86bc-446f-b51a-cc567c1e6649',
                subject: 'Encrypted Message @ pasza.ru',
                from_name: 'Anonymous',
                from_email: 'noreply@pasza.ru',  // фиктивный email
                message: encrypted  // ТОЛЬКО зашифрованный контент
            })
        });

        if (response.ok) {
            showStatus('✅ Зашифрованное сообщение успешно отправлено!', 'success');
            this.reset();
        } else {
            throw new Error('Ошибка отправки');
        }

    } catch (error) {
        console.error('Ошибка:', error);
        showStatus('❌ Ошибка при шифровании или отправке сообщения', 'error');
    } finally {
        formBtn.innerHTML = originalText;
        formBtn.disabled = false;
    }
});

// PGP Modal functionality
const pgpModalBtn = document.querySelector('[data-pgp-modal-btn]');
const pgpModalContainer = document.querySelector('[data-pgp-modal-container]');
const pgpModalCloseBtn = document.querySelector('[data-pgp-modal-close-btn]');
const pgpOverlay = document.querySelector('[data-pgp-overlay]');
const copyKeyBtn = document.getElementById('copy-key-btn');

// PGP modal toggle function
const pgpModalFunc = function () {
    pgpModalContainer.classList.toggle('active');
    pgpOverlay.classList.toggle('active');
};

// Add click event to PGP modal trigger
pgpModalBtn.addEventListener('click', pgpModalFunc);

// Add click event to modal close button
pgpModalCloseBtn.addEventListener('click', pgpModalFunc);
pgpOverlay.addEventListener('click', pgpModalFunc);

// Copy key to clipboard
copyKeyBtn.addEventListener('click', function () {
    const keyContent = document.getElementById('pgp-key-content').textContent;

    navigator.clipboard.writeText(keyContent).then(function () {
        // Временно меняем текст кнопки
        const originalText = copyKeyBtn.textContent;
        copyKeyBtn.textContent = 'Скопировано!';
        copyKeyBtn.style.background = '#0f4c3a';
        copyKeyBtn.style.color = '#4ade80';

        setTimeout(function () {
            copyKeyBtn.textContent = originalText;
            copyKeyBtn.style.background = '#383838';
            copyKeyBtn.style.color = '#d0d0d0';
        }, 2000);
    }).catch(function () {
        alert('Не удалось скопировать ключ. Выделите текст вручную.');
    });
});
